# Investigation Report: Global Users vs. Local Customers

## 1. Problem Definition

The current architecture has a dilemma:

- `User` is a global entity (someone can book in multiple shops).
- But for a specific shop (Enterprise), they want a "local" list of their customers.
- A "Guest/Walk-in" is currently just name/phone strings in an appointment, which doesn't allow for history or loyalty tracking.

## 2. Model Analysis

### Current State

- `User`: Global entity with an `enterprise_id` (this seems to be used for Employees/Admins, but it's ambiguous for Customers).
- `Appointment`: Points to a `User` (optional) OR has string fields for Guest.

### The Conflict

If a `User` has `enterprise_id`, they "belong" to one shop. If they book in another shop, what happens? If `enterprise_id` is null for customers, how does a shop know who "their" customers are without scanning all appointments?

---

## 3. Proposed Architectures

### Option A: The "Relationship" Table (Recommended for CRM)

Create a `Customer` entity that acts as a bridge between an `Enterprise` and a `User`.

**`Customer` Entity:**

- `id`
- `enterprise_id` (FK)
- `user_id` (FK, Nullable) - Links to global account.
- `nickname/internal_name` - Custom name the barber uses.
- `phone` - Copied from User or unique for Guest.
- `total_spent` / `last_visit_date` - Metadata for the shop.

**Pros:**

- A shop can have "Guest" customers (User=null) and "Linked" customers (User=id).
- History is easy to track per shop.
- The shop can add private notes about a customer that other shops can't see.

### Option B: The "Virtual" CRM (Query-based)

Instead of a new table, a shop's "Customer List" is dynamically generated by querying `DISTINCT(user_id, customer_name, customer_phone)` from the `appointments` table.

**Pros:** No new tables.
**Cons:** Very slow as the database grows. Hard to store "Notes" or specific loyalty data per customer.

---

## 4. Operational Flow (The "Magic" Link)

1. **Walk-in Flow**: Admin creates appointment. We search for a `Customer` in that shop by phone.
   - Found? Link it.
   - Not found? Create NEW `Customer` (Guest mode).
2. **Global User Booking**: A user with email `javi@gmail.com` books.
   - On the first booking in Shop X, the system automatically creates a `Customer` record for Shop X linked to that `User`.
3. **The Benefit**: When the barber opens the "Calendar", they see "Javi (3rd visit, usually likes fade)".

---

## 5. Decision Points

- Do we want to allow barbers to see a customer's history in *other* shops? (Privacy concern).
- Do we want to automatically promote a Guest to a User if they register with the same phone?

## 6. Next Step Recommendation

Implement the **`Customer` entity**. It solves the "Global vs Local" problem and provides the foundation for the "Customer List" feature the user mentioned earlier.
